{
    "_comment": "qemu at MacOS doesn't support kvm accelerator, it will use the default accelerator, if no accelerator is defined",
    "__comment": "qemu at MacOS doesn't come with SDL support, use_default_display must be set to true",
    "builders": [
        {
            "accelerator": "kvm",
            "boot_wait": "{{user `boot_wait`}}",
            "disk_size": "{{ user `disk_size` }}",
            "format": "raw",
            "disk_interface": "virtio",
            "headless": "{{user `headless`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_url": "{{user `iso_url`}}",
            "name": "windows-server-qemu",
            "output_directory": "target-qemu",
            "qemuargs": [
                ["-m", "{{ user `memory_size` }}m"],
                ["-smp", "cpus={{ user `cpus` }},maxcpus=16,cores=4"],
                [ "-drive", "file=target-qemu/{{ .Name }},if=virtio,cache=writeback,discard=ignore,format=raw,index=1" ],
                ["-drive", "file={{ user `virtio_win_iso` }},media=cdrom,index=3"]
            ],
            "shutdown_command": "{{user `shutdown_command`}}",
            "ssh_username": "{{user `ssh_username`}}",
            "ssh_private_key_file": "{{user `ssh_private_key_file`}}",
            "ssh_wait_timeout": "{{user `ssh_wait_timeout`}}",
            "type": "qemu",
            "vm_name": "{{user `vm_name`}}",
            "vnc_bind_address": "{{user `vnc_bind_address`}}",
            "floppy_files": [
                "Autounattend.xml",
                "redhat.cer",
                "scripts/microsoft-updates.bat",
                "scripts/win-updates.ps1",
                "scripts/openssh.ps1"
            ]
        },
        {

            "disk_size": "{{ user `disk_size` }}",
            "guest_os_type": "Windows2016_64",
            "headless": "{{user `headless`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "iso_checksum_type": "{{user `iso_checksum_type`}}",
            "iso_url": "{{user `iso_url`}}",
            "name": "windows-server-vbox",
            "vboxmanage": [
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--memory",
                    "{{ user `memory_size` }}"
                ],
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--cpus",
                    "{{ user `cpus` }}"
                ]
            ],
            "shutdown_command": "{{user `shutdown_command`}}",
            "ssh_username": "{{user `ssh_username`}}",
            "ssh_private_key_file": "{{user `ssh_private_key_file`}}",
            "ssh_wait_timeout": "{{user `ssh_wait_timeout`}}",
            "type": "virtualbox-iso",
            "vm_name": "{{user `vm_name`}}",
            "hard_drive_interface": "sata",
            "iso_interface": "sata",
            "guest_additions_mode": "attach",
            "floppy_files": [
                "Autounattend.xml",
                "scripts/microsoft-updates.bat",
                "scripts/win-updates.ps1",
                "scripts/openssh.ps1"
            ]
    	}
    ],
    "provisioners": [
       {
            "type": "powershell",
            "script": "scripts/configureRemotingForAnsible.ps1"

       },
       {
            "type": "windows-shell",
            "script": "scripts/disableAutoLogon.bat"
       },
       {
            "type": "windows-shell",
            "script": "scripts/guestAdditions.bat",
            "only": ["windows-server-vbox"]
       },
       {
            "type": "file",
            "source": "scripts/spice-guest-tools.exe",
            "destination": "C:/Windows/Temp/",
            "only": ["windows-server-qemu"]
       },
       {
            "type": "powershell",
            "scripts": [
                "scripts/spiceTools.ps1", 
                "scripts/Install-CloudBaseInit.ps1"
            ],
            "only": ["windows-server-qemu"]
       },
       {
            "type": "powershell",
            "script": "scripts/fixes.ps1"
       }
    ],
    "post-processors": [
       {
  	    "type": "vagrant",
  	    "output" : "target-vbox/windows-server.box",
            "vagrantfile_template": "Vagrantfile-template",
  	    "only": ["windows-server-vbox"]
       }
    ],
    "variables": {
        "boot_wait": "5s",
        "cpus": "4",
        "disk_size": "16384",
        "headless": "false",
        "iso_checksum": "3022424f777b66a698047ba1c37812026b9714c5",
        "iso_checksum_type": "sha1",
        "iso_url": "https://software-download.microsoft.com/download/pr/17763.737.190906-2324.rs5_release_svc_refresh_SERVER_EVAL_x64FRE_en-us_1.iso",
        "memory_size": "4096",
        "shutdown_command": "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
        "ssh_username": "windows",
        "ssh_private_key_file": "vagrant-key",
        "ssh_wait_timeout": "3h",
        "vm_name": "windows-server",
        "vnc_bind_address": "0.0.0.0",
        "virtio_win_iso": "virtio-win.iso"
    }
}
